services:
  traefik:
    image: traefik:v3.1
    profiles: ["proxy"]
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${TRAEFIK_ACME_EMAIL:-change-me@example.com}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-letsencrypt:/letsencrypt
    networks:
      - proxy
    restart: unless-stopped

  postgres:
    image: postgis/postgis:16-3.4
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: covoiturage
    ports: ["5432:5432"]
    volumes: [pgdata:/var/lib/postgresql/data]
    restart: unless-stopped

  redis:
    image: redis:7
    ports: ["6379:6379"]
    restart: unless-stopped

  meilisearch:
    image: getmeili/meilisearch:latest
    environment:
      MEILI_NO_ANALYTICS: "true"
    ports: ["7700:7700"]
    restart: unless-stopped

  redpanda:
    image: redpandadata/redpanda:latest
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - 1G
      - --reserve-memory
      - 0M
      - --node-id
      - "0"
      - --check=false
      - --set
      - redpanda.auto_create_topics_enabled=true
      # listeners internes/externes
      - --kafka-addr
      - INTERNAL://0.0.0.0:9092,EXTERNAL://0.0.0.0:19092
      - --advertise-kafka-addr
      - INTERNAL://redpanda:9092,EXTERNAL://localhost:19092
      - --rpc-addr
      - 0.0.0.0:33145
      - --advertise-rpc-addr
      - redpanda:33145
      # (optionnel) pandaproxy interne
      - --pandaproxy-addr
      - 0.0.0.0:8082
      - --advertise-pandaproxy-addr
      - redpanda:8082
    ports:
      - "19092:19092"   # accès Kafka depuis l’hôte => localhost:19092
      - "19644:9644"    # Admin API (hôte => localhost:19644)
    restart: unless-stopped

  redpanda-console:
    image: redpandadata/console:latest
    environment:
      KAFKA_BROKERS: "redpanda:9092"
    ports: ["8082:8080"]
    depends_on: [redpanda]
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./ops:/etc/prometheus:ro
    ports: ["9091:9090"]  # évite le conflit avec un 9090 local déjà pris
    restart: unless-stopped
    depends_on:
      - postgres-exporter
      - redpanda
      - redis
      - meilisearch

  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    ports: ["3007:3000"]
    depends_on: [prometheus]
    restart: unless-stopped

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    environment:
      DATA_SOURCE_NAME: postgresql://app:app@postgres:5432/covoiturage?sslmode=disable
    depends_on: [postgres]
    restart: unless-stopped

  pgadmin:
    image: dpage/pgadmin4:8.8
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@local.test
      PGADMIN_DEFAULT_PASSWORD: admin123
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin:/var/lib/pgadmin
    ports: ["5050:80"]
    depends_on: [postgres]
    restart: unless-stopped

  bff:
    build: ./services/bff
    env_file: ./services/bff/.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      RIDE_URL: http://ride:3000
      SEARCH_URL: http://search:3000
      BOOKING_URL: http://booking:3000
      PAYMENT_URL: http://payment:3000
      WALLET_URL: http://wallet:3000
      IDENTITY_URL: http://identity:3000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-super-internal-key}
    depends_on: [ride, search, booking, identity]
    ports: ["3000:3000"]
    restart: unless-stopped

  identity:
    build: ./services/identity
    env_file:
      - ./services/identity/.env
      - ./.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      APP_PUBLIC_URL: ${APP_PUBLIC_URL:-http://82.112.255.155}
      FRONTEND_URL: ${FRONTEND_URL:-http://82.112.255.155}
      MIGRATIONS_RUN: 'true'
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-super-internal-key}
    dns:
      - 1.1.1.1
      - 8.8.8.8
    depends_on: [postgres, redpanda]
    ports: ["3001:3000"]
    restart: unless-stopped

  ride:
    build: ./services/ride
    env_file: ./services/ride/.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      MIGRATIONS_RUN: 'true'
      IDENTITY_URL: http://identity:3000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-super-internal-key}
    depends_on: [postgres, redpanda]
    ports: ["3002:3000"]
    restart: unless-stopped

  search:
    build: ./services/search
    env_file: ./services/search/.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      MEILISEARCH_URL: http://meilisearch:7700
    depends_on: [meilisearch, redpanda]
    ports: ["3003:3000"]
    restart: unless-stopped

  booking:
    build: ./services/booking
    env_file: ./services/booking/.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      REDIS_URL: redis://redis:6379
      MIGRATIONS_RUN: 'true'
      RIDE_URL: http://ride:3000
      WALLET_URL: http://wallet:3000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-super-internal-key}
    depends_on: [redis, redpanda, ride, wallet, postgres]
    ports: ["3004:3000"]
    restart: unless-stopped

  payment:
    build: ./services/payment
    env_file: ./services/payment/.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      MIGRATIONS_RUN: 'true'
    depends_on: [redpanda]
    ports: ["3005:3000"]
    restart: unless-stopped

  wallet:
    build: ./services/wallet
    env_file: ./services/wallet/.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      MIGRATIONS_RUN: 'true'
    depends_on: [postgres, redpanda]
    ports: ["3008:3000"]
    restart: unless-stopped

  payouts:
    build: ./services/payouts
    env_file: ./services/payouts/.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      MIGRATIONS_RUN: 'true'
    depends_on: [redpanda, wallet, postgres]
    ports: ["3009:3000"]
    restart: unless-stopped

  notification:
    build: ./services/notification
    env_file:
      - ./services/notification/.env
      - ./.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      FRONTEND_URL: ${FRONTEND_URL:-http://82.112.255.155}
    dns:
      - 1.1.1.1
      - 8.8.8.8
    depends_on: [redpanda]
    ports: ["3010:3000"]
    restart: unless-stopped

  messaging:
    build: ./services/messaging
    env_file: ./services/messaging/.env
    environment:
      KAFKA_BROKERS: redpanda:9092
      MIGRATIONS_RUN: 'true'
    depends_on: [postgres, redpanda]
    ports: ["3012:3012"]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3012/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 15s
      timeout: 5s
      retries: 8
      start_period: 20s
    restart: unless-stopped

  webapp:
    build:
      context: ./services/webapp
      dockerfile: Dockerfile
      args:
        VITE_SEARCH_URL: /api/search
        VITE_BOOKING_URL: /api/booking
        VITE_RIDE_URL: /api/ride
        VITE_PAYMENT_URL: /api/payment
        VITE_IDENTITY_URL: /api/identity
        VITE_MESSAGING_URL: /api/messaging
    depends_on:
      search:
        condition: service_started
      booking:
        condition: service_started
      messaging:
        condition: service_started
    ports: ["3006:80"]
    restart: unless-stopped
    networks:
      - default
      - proxy
    labels:
      - traefik.enable=true
      - traefik.http.routers.webapp.rule=Host(`${WEBAPP_HOST:-82.112.255.155}`)
      - traefik.http.routers.webapp.entrypoints=web
      - traefik.http.routers.webapp-secure.rule=Host(`${WEBAPP_HOST:-82.112.255.155}`)
      - traefik.http.routers.webapp-secure.entrypoints=websecure
      - traefik.http.routers.webapp-secure.tls=true
      - traefik.http.routers.webapp-secure.tls.certresolver=letsencrypt
      - traefik.http.services.webapp.loadbalancer.server.port=80



  config:
    build: ./services/config
    env_file: ./services/config/.env
    ports: ["3011:3000"]
    restart: unless-stopped

volumes:
  pgdata: {}
  pgadmin: {}
  traefik-letsencrypt: {}

networks:
  proxy:
    driver: bridge
