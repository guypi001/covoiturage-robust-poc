databases:
  - name: covoiturage-postgres
    databaseName: covoiturage
    user: app
    plan: basic-256mb
    region: frankfurt

envVarGroups:
  # Valeurs non sensibles partag√©es entre plusieurs services
  - name: shared-config
    envVars:
      - key: SMTP_PORT
        value: "587"
      - key: SMTP_SECURE
        value: "false"
      - key: SMTP_FROM
        value: "KariGo <noreply@example.com>"
      - key: FRONTEND_URL
        value: https://webapp.onrender.com
      - key: IDENTITY_INTERNAL_URL
        value: https://identity.onrender.com
      - key: GMAIL_OTP_TTL_MINUTES
        value: "10"
      - key: GMAIL_OTP_LENGTH
        value: "6"
      - key: GMAIL_OTP_MAX_ATTEMPTS
        value: "5"

  - name: shared-infra
    envVars:
      - key: KAFKA_BROKERS
        value: redpanda:9092
      - key: REDIS_URL
        value: redis://redis:6379

  - name: service-urls
    envVars:
      - key: IDENTITY_URL
        value: https://identity.onrender.com
      - key: RIDE_URL
        value: https://ride.onrender.com
      - key: SEARCH_URL
        value: https://search.onrender.com
      - key: BOOKING_URL
        value: https://booking.onrender.com
      - key: PAYMENT_URL
        value: https://payment.onrender.com
      - key: WALLET_URL
        value: https://wallet.onrender.com

  - name: search-config
    envVars:
      - key: MEILISEARCH_URL
        value: http://meilisearch:7700
      - key: NEAR_RADIUS_KM
        value: "80"
      - key: CORRIDOR_KM
        value: "45"
      - key: SEARCH_LIMIT
        value: "60"

services:
  # Streaming (Kafka) backbone
  - type: pserv
    name: redpanda
    runtime: docker
    region: frankfurt
    plan: standard
    rootDir: ops/render/redpanda
    dockerfilePath: Dockerfile

  # Redis cache / locking layer
  - type: pserv
    name: redis
    runtime: docker
    region: frankfurt
    plan: standard
    rootDir: ops/render/redis
    dockerfilePath: Dockerfile

  # Meilisearch for ride discovery
  - type: pserv
    name: meilisearch
    runtime: docker
    region: frankfurt
    plan: standard
    rootDir: ops/render/meilisearch
    dockerfilePath: Dockerfile

  # Observability - Prometheus
  - type: web
    name: prometheus
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: ops
    dockerfilePath: render/prometheus/Dockerfile

  # Observability - Grafana
  - type: web
    name: grafana
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: ops/render/grafana
    dockerfilePath: Dockerfile
    envVars:
      - key: GF_SECURITY_ADMIN_PASSWORD
        sync: false

  # Redpanda console (Kafka UI)
  - type: web
    name: redpanda-console
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: ops/render/redpanda-console
    dockerfilePath: Dockerfile
    envVars:
      - key: KAFKA_BROKERS
        value: redpanda:9092

  # Identity service (JWT + mailing)
  - type: web
    name: identity
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/identity
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-config
      - fromGroup: shared-infra
      - key: DATABASE_URL
        fromDatabase:
          name: covoiturage-postgres
          property: connectionString
      - key: JWT_SECRET
        sync: false
      - key: JWT_EXPIRES_IN
        value: 2h
      - key: SMTP_HOST
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: INTERNAL_API_KEY
        sync: false

  # Ride management microservice
  - type: web
    name: ride
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/ride
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra
      - key: DATABASE_URL
        fromDatabase:
          name: covoiturage-postgres
          property: connectionString

  # Search / discovery service
  - type: web
    name: search
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/search
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra
      - fromGroup: search-config

  # Booking orchestration service
  - type: web
    name: booking
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/booking
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra
      - fromGroup: service-urls
      - key: DATABASE_URL
        fromDatabase:
          name: covoiturage-postgres
          property: connectionString

  # Payment mock service
  - type: web
    name: payment
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/payment
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra

  # Wallet / ledger
  - type: web
    name: wallet
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/wallet
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra
      - key: DATABASE_URL
        fromDatabase:
          name: covoiturage-postgres
          property: connectionString

  # Payouts simulation
  - type: web
    name: payouts
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/payouts
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra

  # Notification service (emails + Kafka consumers)
  - type: web
    name: notification
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/notification
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-config
      - fromGroup: shared-infra
      - key: SMTP_HOST
        sync: false
      - key: SMTP_USER
        sync: false
      - key: SMTP_PASS
        sync: false
      - key: INTERNAL_API_KEY
        sync: false

  # Messaging / WebSocket service
  - type: web
    name: messaging
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/messaging
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra
      - key: DATABASE_URL
        fromDatabase:
          name: covoiturage-postgres
          property: connectionString

  # API gateway / BFF
  - type: web
    name: bff
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/bff
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra
      - fromGroup: service-urls

  # Config service (feature flags, etc.)
  - type: web
    name: config
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/config
    dockerfilePath: Dockerfile
    envVars:
      - fromGroup: shared-infra

  # Web SPA (Vite + Nginx)
  - type: web
    name: webapp
    runtime: docker
    region: frankfurt
    plan: starter
    rootDir: services/webapp
    dockerfilePath: Dockerfile
